<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
    <style>
        #results {
            display: none;
        }
        #content {
            white-space: pre-wrap;
            
        }
    </style>
</head>
<body>
    <h1>Result</h1>
    <div id="results"></div>
    <div id="content"></div>
    <script>
        const converter = new showdown.Converter();

        function convertToMarkdown(input) {
            // <br> 태그를 개행 문자로 대체
            let markdown = input.replace(/<br\s*\/?>/gi, '\n');
            
            // 특수 문자를 원래 문자로 변환
            markdown = markdown.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');

            // 코드 블록을 마크다운 형식으로 변환
            markdown = markdown.replace(/```([^`]+)```/g, (match, code) => {
                return `\n\`\`\`\n${code}\n\`\`\`\n`;
            });

            return markdown;
        }

        if (!!window.EventSource) {
            const eventSource = new EventSource("{% url 'chat_view' %}?query={{ query }}");

            eventSource.onmessage = function(event) 
            {
                const data = JSON.parse(event.data);
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML += `${data.message}`;
                
               
                const contentDiv = document.getElementById('content');
                const markdownContent = convertToMarkdown(resultsDiv.innerHTML);
                const resultContent = converter.makeHtml(markdownContent);
                contentDiv.innerHTML = resultContent;

            };

            eventSource.onerror = function(event) {
                console.log(event);
                eventSource.close();
            };
        } else {
            console.log("Your browser does not support Server-Sent Events.");
        } 

    </script>
</body>
</html>