{% extends "base.html" %} {% block content %}
<div class="container mt-5">
  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h1 class="card-title">풀이 결과</h1>
        </div>
        <div class="card-body">
          {% if correct %}
          <div class="alert alert-success">정답!</div>
          {% else %}
          <div class="alert alert-danger">오답입니다. 다시 시도해 보세요.</div>
          {% endif %}
          <p><strong>모범답안</strong></p>
          <p>
            파일 다운로드 기능은 파일 경로를 제대로 검증하지 않으면 경로 조작
            공격(Path Traversal Attack)에 취약해질 수 있습니다. 공격자는 파일
            경로를 조작하여 서버의 민감한 파일을 다운로드할 수 있습니다.
          </p>
          <p>
            예를 들어, <code>../../../../etc/passwd</code>와 같은 경로를
            입력하여 서버의 시스템 파일을 다운로드할 수 있습니다. 이러한
            취약점을 방지하기 위해서는 파일 경로를 검증하고, 허용된 디렉터리
            내의 파일만 접근할 수 있도록 제한해야 합니다.
          </p>
          <p>다음은 안전한 파일 다운로드 예제 코드입니다:</p>
          <pre class="p-3 border bg-light">
            ```python
            def download_file(request):
                file_path = request.GET.get("file")
                if file_path:
                    # Normalize the path to prevent path traversal
                    file_path = os.path.normpath(file_path)
                    allowed_directory = os.path.join(BASE_DIR, "uploads")
                    full_path = os.path.join(allowed_directory, file_path)
                    
                    # Ensure the requested file is within the allowed directory
                    if os.path.commonprefix([full_path, allowed_directory]) == allowed_directory:
                        if os.path.exists(full_path):
                            with open(full_path, "rb") as f:
                                response = HttpResponse(f.read(), content_type="application/octet-stream")
                                response["Content-Disposition"] = f'attachment; filename="{os.path.basename(full_path)}"'
                                return response
                return HttpResponseNotFound("파일을 찾을 수 없습니다")
            ```</pre
          >
          <a href="{% url 'solve' %}" class="btn btn-secondary"
            >다른 문제 풀어보기</a
          >
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <h2 class="mb-4">더 알아보기</h2>
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
          <a
            class="nav-link active"
            id="intro-tab"
            data-toggle="tab"
            href="#intro"
            role="tab"
            aria-controls="intro"
            aria-selected="true"
            >서론</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="php-tab"
            data-toggle="tab"
            href="#php"
            role="tab"
            aria-controls="php"
            aria-selected="false"
            >php</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="jsp-tab"
            data-toggle="tab"
            href="#jsp"
            role="tab"
            aria-controls="jsp"
            aria-selected="false"
            >jsp</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="python-tab"
            data-toggle="tab"
            href="#python"
            role="tab"
            aria-controls="python"
            aria-selected="false"
            >python</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="conclusion-tab"
            data-toggle="tab"
            href="#conclusion"
            role="tab"
            aria-controls="conclusion"
            aria-selected="false"
            >결론</a
          >
        </li>
      </ul>
      <div class="tab-content" id="myTabContent">
        <div
          class="tab-pane fade show active"
          id="intro"
          role="tabpanel"
          aria-labelledby="intro-tab"
        >
          <p id="intro-content">실시간 답변 생성 중...</p>
        </div>
        <div
          class="tab-pane fade"
          id="php"
          role="tabpanel"
          aria-labelledby="php-tab"
        >
          <p id="php-content">실시간 답변 생성 중...</p>
        </div>
        <div
          class="tab-pane fade"
          id="jsp"
          role="tabpanel"
          aria-labelledby="jsp-tab"
        >
          <p id="jsp-content">실시간 답변 생성 중...</p>
        </div>
        <div
          class="tab-pane fade"
          id="python"
          role="tabpanel"
          aria-labelledby="python-tab"
        >
          <p id="python-content">실시간 답변 생성 중...</p>
        </div>
        <div
          class="tab-pane fade"
          id="conclusion"
          role="tabpanel"
          aria-labelledby="conclusion-tab"
        >
          <p id="conclusion-content">실시간 답변 생성 중...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const converter = new showdown.Converter();
  function convertToMarkdown(input) {
    let markdown = input.replace(/<br\s*\/?>/gi, "\n");
    markdown = markdown
      .replace(/&lt;/g, "<")
      .replace(/&gt;/g, ">")
      .replace(/&amp;/g, "&");
    markdown = markdown.replace(/```([^`]+)```/g, (match, code) => {
      return `\n\`\`\`\n${code}\n\`\`\`\n`;
    });
    return markdown;
  }
  function InsertMarkdownContent(messages) {
    if (messages != null) {
      const markdownContent = convertToMarkdown(messages);
      const resultContent = converter.makeHtml(markdownContent);
      return resultContent;
    } else {
      return "실시간 답변 생성 중...";
    }
  }
  if (!!window.EventSource) {
    const eventSource = new EventSource(
      "{% url 'chat_view' %}?query={{ query }}"
    );

    let messages = "";
    eventSource.onmessage = function (event) {
      const data = JSON.parse(event.data);
      messages += `${data.message}`;

      const splitData = messages.split("----");

      if (splitData.length >= 2) {
        document.getElementById("intro-content").innerHTML =
          InsertMarkdownContent(splitData[1]);
      }
      if (splitData.length >= 3) {
        document.getElementById("php-content").innerHTML =
          InsertMarkdownContent(splitData[2]);
      }
      if (splitData.length >= 4) {
        document.getElementById("jsp-content").innerHTML =
          InsertMarkdownContent(splitData[3]);
      }
      if (splitData.length >= 5) {
        document.getElementById("python-content").innerHTML =
          InsertMarkdownContent(splitData[4]);
      }
      if (splitData.length >= 6) {
        document.getElementById("conclusion-content").innerHTML =
          InsertMarkdownContent(splitData[5]);
      }
    };

    eventSource.onerror = function (event) {
      console.log(event);
      eventSource.close();
    };
  } else {
    console.log("Your browser does not support Server-Sent Events.");
  }
</script>
{% endblock %}
