{% extends "base.html" %} {% block content %}
<div class="container mt-5">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <h2 class="mb-4">더 알아보기</h2>
      <div>
        Input Validation 공격에 대한 설명을 확인해보세요. 어떤 공격인지, 각 서버
        사이드 스크립팅 언어별로 어떻게 방어할 수 있는지, 그리고 관련 공격
        사례들을 알아보겠습니다.
      </div>
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
          <a
            class="nav-link active"
            id="intro-tab"
            data-toggle="tab"
            href="#intro"
            role="tab"
            aria-controls="intro"
            aria-selected="true"
            >서론</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="C-tab"
            data-toggle="tab"
            href="#C"
            role="tab"
            aria-controls="C"
            aria-selected="false"
            >C</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="jsp-tab"
            data-toggle="tab"
            href="#jsp"
            role="tab"
            aria-controls="jsp"
            aria-selected="false"
            >jsp</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="python-tab"
            data-toggle="tab"
            href="#python"
            role="tab"
            aria-controls="python"
            aria-selected="false"
            >python</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="real-case-tab"
            data-toggle="tab"
            href="#real-case"
            role="tab"
            aria-controls="real-case"
            aria-selected="false"
            >실제 사례</a
          >
        </li>
      </ul>
      <div class="tab-content" id="myTabContent">
        <div
          class="tab-pane fade show active"
          id="intro"
          role="tabpanel"
          aria-labelledby="intro-tab"
        >
          <p id="intro-content">실시간 답변 생성 중...</p>
        </div>
        <div
          class="tab-pane fade"
          id="C"
          role="tabpanel"
          aria-labelledby="C-tab"
        >
          <p id="C-content">실시간 답변 생성 중...</p>
        </div>
        <div
          class="tab-pane fade"
          id="jsp"
          role="tabpanel"
          aria-labelledby="jsp-tab"
        >
          <p id="jsp-content">실시간 답변 생성 중...</p>
        </div>
        <div
          class="tab-pane fade"
          id="python"
          role="tabpanel"
          aria-labelledby="python-tab"
        >
          <p id="python-content">실시간 답변 생성 중...</p>
        </div>
        <div
          class="tab-pane fade"
          id="real-case"
          role="tabpanel"
          aria-labelledby="real-case-tab"
        >
          <p id="real-case-content">실시간 답변 생성 중...</p>
        </div>
      </div>
      <a href="{% url 'solve' %}" class="btn btn-secondary mt-3"
        >다른 문제 풀어보기</a
      >
    </div>
  </div>
</div>

<script>
  const converter = new showdown.Converter();

  function convertToMarkdown(input) {
    // <br> 태그를 개행 문자로 대체
    let markdown = input.replace(/<br\s*\/?>/gi, "\n");

    // 특수 문자를 원래 문자로 변환
    markdown = markdown
      .replace(/&lt;/g, "<")
      .replace(/&gt;/g, ">")
      .replace(/&amp;/g, "&");

    // 코드 블록을 마크다운 형식으로 변환
    markdown = markdown.replace(/```([^`]+)```/g, (match, code) => {
      return `\n\`\`\`\n${code}\n\`\`\`\n`;
    });
    return markdown;
  }

  function insertMarkdownContent(messages) {
    if (messages != null) {
      const markdownContent = convertToMarkdown(messages);
      const resultContent = converter.makeHtml(markdownContent);
      return resultContent;
    } else {
      return "실시간 답변 생성 중...";
    }
  }

  if (!!window.EventSource) {
    const eventSource = new EventSource(
      "{% url 'chat_view' %}?query={{ query }}"
    );

    let messages = "";
    eventSource.onmessage = function (event) {
      const data = JSON.parse(event.data);
      messages += `${data.message}`;

      const splitData = messages.split("----");

      if (splitData.length >= 2) {
        document.getElementById("intro-content").innerHTML =
          insertMarkdownContent(splitData[1]);
      }
      if (splitData.length >= 3) {
        document.getElementById("C-content").innerHTML = insertMarkdownContent(
          splitData[2]
        );
      }
      if (splitData.length >= 4) {
        document.getElementById("jsp-content").innerHTML =
          insertMarkdownContent(splitData[3]);
      }
      if (splitData.length >= 5) {
        document.getElementById("python-content").innerHTML =
          insertMarkdownContent(splitData[4]);
      }
      if (splitData.length >= 6) {
        document.getElementById("real-case-content").innerHTML =
          insertMarkdownContent(splitData[5]);
      }
    };

    eventSource.onerror = function (event) {
      console.log(event);
      eventSource.close();
    };
  } else {
    console.log("Your browser does not support Server-Sent Events.");
  }
</script>
{% endblock %}
