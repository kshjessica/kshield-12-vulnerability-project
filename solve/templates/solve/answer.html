{% extends "base.html" %} {% block content %}
<div class="container mt-5">
  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h1 class="card-title">풀이 결과</h1>
        </div>
        <div class="card-body">
          {% if correct %}
          <div class="alert alert-success">정답!</div>
          {% else %}
          <div class="alert alert-danger">오답입니다. 다시 시도해 보세요.</div>
          {% endif %}
          <p><strong>모범답안</strong></p>
          <p>{{ question.question_answer }}</p>
          <a href="{% url 'solve' %}" class="btn btn-secondary"
            >다른 문제 풀어보기</a
          >
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <h2 class="mb-4">더 알아보기</h2>
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
          <a
            class="nav-link active"
            id="intro-tab"
            data-toggle="tab"
            href="#intro"
            role="tab"
            aria-controls="intro"
            aria-selected="true"
            >서론</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="php-tab"
            data-toggle="tab"
            href="#php"
            role="tab"
            aria-controls="php"
            aria-selected="false"
            >php</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="jsp-tab"
            data-toggle="tab"
            href="#jsp"
            role="tab"
            aria-controls="jsp"
            aria-selected="false"
            >jsp</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="python-tab"
            data-toggle="tab"
            href="#python"
            role="tab"
            aria-controls="python"
            aria-selected="false"
            >python</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="conclusion-tab"
            data-toggle="tab"
            href="#conclusion"
            role="tab"
            aria-controls="conclusion"
            aria-selected="false"
            >결론</a
          >
        </li>
      </ul>
      <div class="tab-content" id="myTabContent">
        <div
          class="tab-pane fade show active"
          id="intro"
          role="tabpanel"
          aria-labelledby="intro-tab"
        >
          <p id="intro-content">실시간 답변 생성 중...</p>
        </div>
        <div
          class="tab-pane fade"
          id="php"
          role="tabpanel"
          aria-labelledby="php-tab"
        >
          <p id="php-content">실시간 답변 생성 중...</p>
        </div>
        <div
          class="tab-pane fade"
          id="jsp"
          role="tabpanel"
          aria-labelledby="jsp-tab"
        >
          <p id="jsp-content">실시간 답변 생성 중...</p>
        </div>
        <div
          class="tab-pane fade"
          id="python"
          role="tabpanel"
          aria-labelledby="python-tab"
        >
          <p id="python-content">실시간 답변 생성 중...</p>
        </div>
        <div
          class="tab-pane fade"
          id="conclusion"
          role="tabpanel"
          aria-labelledby="conclusion-tab"
        >
          <p id="conclusion-content">실시간 답변 생성 중...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
        const converter = new showdown.Converter();
        function convertToMarkdown(input) {
            // <br> 태그를 개행 문자로 대체
            let markdown = input.replace(/<br\s*\/?>/gi, '\n');

            // 특수 문자를 원래 문자로 변환
            markdown = markdown.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');
        
            // 코드 블록을 마크다운 형식으로 변환
            markdown = markdown.replace(/```([^`]+)```/g, (match, code) => {
                return `\n\`\`\`\n${code}\n\`\`\`\n`;
            });
            return markdown;
        }
        function InsertMarkdownContent(massages)
        {
            if(massages!= null)
            {
                const markdownContent = convertToMarkdown(massages);
                const resultContent = converter.makeHtml(markdownContent);
                return resultContent
            }
            else
            {
                return "실시간 답변 생성 중..."
            }
        }
        if (!!window.EventSource) {
            const eventSource = new EventSource("{% url 'chat_view' %}?query={{ query }}");
        
            let massages = ''
            eventSource.onmessage = function(event) 
            {
                const data = JSON.parse(event.data);
                massages += `${data.message}`;

                const splitData = massages.split('----');
            
                switch(splitData.length)
                {
                    case 2:
                        document.getElementById("intro-content").innerHTML = InsertMarkdownContent(splitData[1]);
                    case 3:
                        document.getElementById("php-content").innerHTML = InsertMarkdownContent(splitData[2]);
                    case 4:            
                        document.getElementById("jsp-content").innerHTML = InsertMarkdownContent(splitData[3]);
                    case 5:
                        document.getElementById("python-content").innerHTML = InsertMarkdownContent(splitData[4]);
                    case 6:                   
                        document.getElementById("conclusion-content").innerHTML =InsertMarkdownContent(splitData[5]);
                }

            };
            eventSource.onerror = function(event) {
                console.log(event);
                eventSource.close();
            };
        } else {
            console.log("Your browser does not support Server-Sent Events.");
        } 
</script>
{% endblock %}
